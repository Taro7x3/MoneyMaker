name: Generate Post and Deploy to Lolipop

on:
  workflow_dispatch: # Allows manual triggering
  schedule:
    - cron: '0 22 * * *' # Runs every day at 22:00 UTC (7:00 JST)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python Dependencies
        run: pip install python-amazon-paapi --upgrade # The correct, original library

      - name: Generate New Post
        env:
          PAAPI_ACCESS_KEY: ${{ secrets.PAAPI_ACCESS_KEY }}
          PAAPI_SECRET_KEY: ${{ secrets.PAAPI_SECRET_KEY }}
          ASSOCIATE_TAG: ${{ secrets.ASSOCIATE_TAG }}
        run: python scripts/generate_post.py
      
      - name: Commit and Push New Post
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add content/posts/
          git diff --quiet && git diff --staged --quiet || git commit -m "feat: Add new post generated by AI"
          git push

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'

      - name: Build
        run: hugo --minify

      - name: Deploy with lftp
        run: |
          sudo apt-get update && sudo apt-get install -y lftp
          lftp -u "${{ secrets.SSH_USERNAME }},${{ secrets.SSH_PASSWORD }}" -p ${{ secrets.SSH_PORT }} sftp://${{ secrets.SSH_HOST }} -e "set sftp:auto-confirm yes; mirror -R --delete --verbose ./public/ ${{ secrets.REMOTE_PATH }}; quit"
